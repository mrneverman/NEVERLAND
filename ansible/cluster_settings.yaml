- name: Cluster Settings
  hosts: portOfNeverland
  become_user: fisherman
  vars_files:
  - ./terraform_variables/tf_island-of-intelligence_vars_file.yml
  - ./terraform_variables/tf_network_vars_file.yml
  - ./terraform_variables/tf_k8node_vars_file.yml

  tasks:
  - name: Wait 300 seconds for ssh timeout, but only start checking after 1 seconds
    wait_for_connection:
      delay: 1
      timeout: 300

  - name: taint infrastructure town
    command: kubectl taint node {{item}} purpose=infratown:NoSchedule
    loop: "{{infrastructure_nodes}}"

  - name: taint infrastructure town
    command: kubectl label node {{item}} purpose=infratown
    loop: "{{infrastructure_nodes}}"

  - name: install Pod network
    shell: kubectl apply -f https://projectcalico.docs.tigera.io/manifests/calico.yaml
    args:
      chdir: $HOME

  - name: create monitoring namespace
    command: kubectl create namespace monitoring

  - name: helm repo add metrics-server
    command: helm repo add metrics-server https://kubernetes-sigs.github.io/metrics-server/

  - name: helm repo update
    command: helm repo update

  - name: Copy metrics-server_values.yaml
    copy:
     src: metrics-server_values.yaml
     dest: /tmp
     mode: 0755

  - name: install metrics-server via helm
    command: helm install --namespace monitoring metrics-server metrics-server/metrics-server -f /tmp/metrics-server_values.yaml

  - name: Delete metrics-server_values.yaml
    file:
     path: /tmp/metrics-server_values.yaml
     state: absent

  - name: approve pending certificate
    shell:
      cmd: kubectl get csr | grep Pending | awk '{print $1}' | xargs kubectl certificate approve

