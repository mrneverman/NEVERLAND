- name: Deploy sample bookinfo App
  hosts: portOfNeverland
  vars_files:
  - ./terraform_variables/tf_island-of-intelligence_vars_file.yml
  - ./terraform_variables/tf_network_vars_file.yml
  - ./terraform_variables/tf_k8node_vars_file.yml

  tasks:
  - name: Wait 300 seconds for ssh timeout, but only start checking after 1 seconds
    wait_for_connection:
      delay: 1
      timeout: 300

  - name: label default namespace for istio side-car injection
    become_user: fisherman
    command: kubectl label namespace default istio-injection=enabled

  - name: deploy bookinfo app
    become_user: fisherman
    command: kubectl apply -f /opt/istio-1.13.2/samples/bookinfo/platform/kube/bookinfo.yaml

  - name: deploy bookinfo gateway
    become_user: fisherman
    shell:
      cmd: |
           cat <<EOF | kubectl apply -f -
           apiVersion: networking.istio.io/v1alpha3
           kind: VirtualService
           metadata:
             name: bookinfo
           spec:
             hosts:
             - "*"
             gateways:
             - neverlandgateway
             http:
             - match:
               - uri:
                   exact: /productpage
               - uri:
                   prefix: /static
               - uri:
                   exact: /login
               - uri:
                   exact: /logout
               - uri:
                   prefix: /api/v1/products
               route:
               - destination:
                   host: productpage
                   port:
                     number: 9080
           EOF

  - name: deploy destination rules
    become_user: fisherman
    command: kubectl apply -f /opt/istio-1.13.2/samples/bookinfo/networking/destination-rule-all.yaml


